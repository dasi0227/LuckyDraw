<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.dasi.infrastructure.persistent.dao.IActivityAccountDao">

    <resultMap id="dataMap" type="com.dasi.infrastructure.persistent.po.ActivityAccount">
        <id     property="id"                   column="id"/>
        <result property="userId"               column="user_id"/>
        <result property="activityId"           column="activity_id"/>
        <result property="accountPoint"         column="account_point"/>
        <result property="accountLuck"          column="account_luck"/>
        <result property="totalAllocate"        column="total_allocate"/>
        <result property="totalSurplus"         column="total_surplus"/>
        <result property="dayLimit"             column="day_limit"/>
        <result property="monthLimit"           column="month_limit"/>
        <result property="createTime"           column="create_time"/>
        <result property="updateTime"           column="update_time"/>
    </resultMap>

    <select id="queryActivityAccount" parameterType="com.dasi.infrastructure.persistent.po.ActivityAccount" resultMap="dataMap">
        SELECT user_id, activity_id, account_point, account_luck, total_allocate, total_surplus, month_limit, day_limit
        FROM activity_account
        WHERE user_id = #{userId} AND activity_id = #{activityId};
    </select>

    <select id="queryActivityAccountLuck" parameterType="com.dasi.infrastructure.persistent.po.ActivityAccount" resultType="java.lang.Integer">
        SELECT account_luck
        FROM activity_account
        WHERE user_id = #{userId} AND activity_id = #{activityId};
    </select>

    <select id="queryActivityAccountPoint" parameterType="com.dasi.infrastructure.persistent.po.ActivityAccount" resultType="java.lang.Integer">
        SELECT account_point
        FROM activity_account
        WHERE user_id = #{userId} AND activity_id = #{activityId};
    </select>

    <select id="countByActivityId" parameterType="java.lang.Long" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM activity_account
        WHERE activity_id = #{activityId}
    </select>

    <insert id="createActivityAccount" parameterType="com.dasi.infrastructure.persistent.po.ActivityAccount">
        INSERT INTO activity_account (user_id, activity_id, account_point, account_luck, total_allocate, total_surplus, month_limit, day_limit)
        VALUES (#{userId}, #{activityId}, #{accountPoint}, #{accountLuck}, #{totalAllocate}, #{totalSurplus}, #{monthLimit}, #{dayLimit});
    </insert>

    <update id="increaseActivityAccountRaffle" parameterType="com.dasi.infrastructure.persistent.po.ActivityAccount">
        UPDATE activity_account
        SET total_allocate = total_allocate + #{totalAllocate},
            total_surplus = total_surplus + #{totalSurplus}
        WHERE user_id = #{userId} AND activity_id = #{activityId};
    </update>

    <update id="decreaseActivityAccountRaffle" parameterType="com.dasi.infrastructure.persistent.po.ActivityAccount">
        UPDATE activity_account
        SET total_surplus = total_surplus - 1
        WHERE user_id = #{userId} AND activity_id = #{activityId} AND total_surplus >= 1;
    </update>

    <update id="increaseActivityAccountPoint" parameterType="com.dasi.infrastructure.persistent.po.ActivityAccount">
        UPDATE activity_account
        SET account_point = account_point + #{accountPoint}
        WHERE user_id = #{userId} AND activity_id = #{activityId};
    </update>

    <update id="decreaseActivityAccountPoint" parameterType="com.dasi.infrastructure.persistent.po.ActivityAccount">
        UPDATE activity_account
        SET account_point = account_point - #{accountPoint}
        WHERE user_id = #{userId} AND activity_id = #{activityId} AND account_point >= #{accountPoint};
    </update>

</mapper>